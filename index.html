<!DOCTYPE html><html><head><title>Noble City</title><style>html,body{background-color:#111;width:100%;height:100%;margin:0;padding:0;overflow:hidden;display:flex;justify-content:center;align-items:center;}canvas{display:block;image-rendering:pixelated;object-fit:contain;box-shadow:0 0 30px #000}</style></head><body><canvas id="game"></canvas><script>(()=>{var B=class{x=0;y=0;sm=1;get w(){return Math.floor(this.dom.width/this.sm)}set w(e){this.dom.width=e}get h(){return Math.floor(this.dom.height/this.sm)}set h(e){this.dom.height=e}set s(e){this.sx=e,this.sy=e}sx=1;sy=1;scale(e){this.dom.width*=e,this.dom.height*=e,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._ctx.scale(e,e),this.sm*=e}full(){document.body.requestFullscreen()}def={bz:1};cursor="default";tolisten=[];render(e={},...r){let i=this._eng;r.length||(r=[e],e={});for(let s of r){this._ctx.save();let t={};if(Object.assign(t,this.def,e,s),(t.click||t.hover||t.press)&&t.p!=null&&this.tolisten.push(t),t.f&&t.f in i.audios){i.audios[t.f].active=!0,i.audios[t.f].volume=t.a??1;continue}let p=t.f!=null&&!(t.f in i.imgs),n=t.b!=null&&!(t.b in i.imgs),a=t.crop!=null&&t.crop.length==4,m=t.crop!=null&&t.crop.length==8;if(p&&(this._ctx.fillStyle=t.f),n&&(this._ctx.strokeStyle=t.b),this._ctx.lineCap=t.be=="arc"?"round":t.be=="sqr"?"square":"butt",this._ctx.lineJoin=t.bj=="arc"?"round":t.bj=="sqr"?"bevel":"miter",this._ctx.lineWidth=t.bz??1,t.a==0){this._ctx.restore();continue}this._ctx.globalAlpha=t.a??1,t.c=t.c??1;let[h,l]=[Math.pow(this.sx,t.c),Math.pow(this.sy,t.c)];t.sx=(t.sx??t.s??1)*h,t.sy=(t.sy??t.s??1)*l;let[c,x]=t.r?[Math.sin(t.r),Math.cos(t.r)]:[0,1],[k,I]=[this.w/2*t.c*Math.pow(this.sx,t.c-1)+this.x*(1-t.c-h)+(t.x??0)*h,this.h/2*t.c*Math.pow(this.sy,t.c-1)+this.y*(1-t.c-l)+(t.y??0)*l],ie=this.rect(t);if(this._ctx.transform(t.sx*x,t.sx*c,-t.sy*c,t.sy*x,k,I),t.m&&t.m.length==6?this._ctx.transform.apply(this._ctx,t.m):t.m&&i.error_add(new Error(`Invalid transform [${t.m.toString()}]`)),this._ctx.translate(ie[0][0]/t.sx,ie[0][1]/t.sy),t.f&&!p){let f=t.crop&&a?[t.crop[2]*t.sx*x,t.crop[3]*t.sy*x]:t.crop&&m?[t.crop[4]*(t.crop[6]+1)*t.sx*x,t.crop[5]*(t.crop[7]+1)*t.sy*x]:[this._eng.imgs[t.f].width*t.sx*x,this._eng.imgs[t.f].height*t.sy*x];if(this.w+f[0]<k||this.h+f[1]<I||k+f[0]<0||I+f[1]<0){this._ctx.restore();continue}}if(t.f!=null&&t.f in i.imgs){if(t.crop&&a)this._ctx.drawImage(i.imgs[t.f],t.crop[0],t.crop[1],t.crop[2],t.crop[3],0,0,t.crop[2],t.crop[3]);else if(t.crop&&m)for(let f=0;f<=t.crop[6];f++)for(let _=0;_<=t.crop[7];_++)this._ctx.drawImage(i.imgs[t.f],t.crop[0]*(f==0?0:f==t.crop[6]?1:.5),t.crop[1]*(_==0?0:_==t.crop[7]?1:.5),t.crop[2],t.crop[3],t.crop[4]*f,t.crop[5]*_,t.crop[2],t.crop[3]);else this._ctx.drawImage(i.imgs[t.f],0,0);t.p=t.p??ie}if(t.p){let f=0,_=0;this._ctx.beginPath();for(let b of t.p)b.length==2&&!f?this._ctx.moveTo(b[0],b[1]):b.length==2&&_==1?(this._ctx.lineTo(t.p[f-2][0]+b[0],t.p[f-2][1]),this._ctx.lineTo(t.p[f-2][0]+b[0],t.p[f-2][1]+b[1]),this._ctx.lineTo(t.p[f-2][0],t.p[f-2][1]+b[1])):b.length==2?this._ctx.lineTo(b[0],b[1]):b.length==0&&f>0&&t.p[f-1].length==2&&f+1!=t.p.length&&t.p[f+1].length==2?_=1:b.length==0&&f+1==t.p.length&&this._ctx.closePath(),f++;n&&this._ctx.stroke(),p&&(t.bz??1)&&this._ctx.fill()}if(t.t){let f=t.tz??20,[_,b]=[0,0],[pe,he]=[!1,!1];this._ctx.font=`${f}px ${t.tf&&t.tf in i.fonts?i.fonts[t.tf]:t.tf??"Arial"}`,(pe=[0,.5,1].includes(t.ox))&&(this._ctx.textAlign=t.ox==0?"start":t.ox==1?"end":"center"),(he=[0,.5,1].includes(t.oy))&&(this._ctx.textBaseline=t.oy==0?"top":t.oy==1?"bottom":"middle"),pe||(_=-this._ctx.measureText(t.t).width*t.ox),he||(b=-f*t.oy),n&&(t.bz??1)&&this._ctx.strokeText(t.t,_,b),p||(this._ctx.fillStyle="#000"),(!p&&!n||p)&&this._ctx.fillText(t.t,_,b)}this._ctx.restore()}}play(e,r=1,i=0){if(e in this._eng.audios){let s=new Audio;return s.src=this._eng.base+e,s.volume=r,s.currentTime=i,s.addEventListener("ended",()=>s=null),s.play(),!0}return!1}clear(){this._ctx.clearRect(0,0,this.w,this.h)}fit=!1;fitfull(){let{width:e,height:r}=(this.dom.parentElement||this.dom).getBoundingClientRect(),i=this.w/this.h;e/r>i?(this.dom.style.width="auto",this.dom.style.height="100%"):(this.dom.style.width="100%",this.dom.style.height="auto")}tile(e){let r=e.sx!=null?e.sx:e.s!=null?e.s:this.def.sx!=null?this.def.sx:this.def.s!=null?this.def.s:1,i=e.sy!=null?e.sy:e.s!=null?e.s:this.def.sy!=null?this.def.sy:this.def.s!=null?this.def.s:1,s=this.dom.getBoundingClientRect(),t=s.width/this.w,p=s.height/this.h,n=this.w/innerWidth;if(!e.f||!(e.f in this._eng.imgs))e.f!=null&&(this.dom.style.background=e.f);else{if(!this._tile_pic.includes(e.f)){let a=document.createElement("link");a.setAttribute("rel","preload"),a.setAttribute("href",`${this._eng.base}${e.f}`),a.setAttribute("as","image"),document.body.appendChild(a)}this.dom.style.backgroundImage=`url(${this._eng.base}${e.f})`,this.dom.style.backgroundPosition=`calc(50% + ${((e.x||0)-this.x)*this.sx*t}px) calc(50% + ${((e.y||0)-this.y)*this.sy*p}px)`,this.dom.style.backgroundSize=`${this._eng.imgs[e.f].width*this.sx*r/n}px ${this._eng.imgs[e.f].height*this.sy*i/n}px`}}_tile_pic=[];rect(e){let r=e.f!=null&&!(e.f in this._eng.imgs),i=e.crop!=null&&e.crop.length==4,s=e.crop!=null&&e.crop.length==8;e.ox=e.ox??(!e.o||!e.o.includes("w")&&!e.o.includes("e")?.5:e.o&&e.o.includes("e")?1:0),e.oy=e.oy??(!e.o||!e.o.includes("n")&&!e.o.includes("s")?.5:e.o&&e.o.includes("s")?1:0);let t=e.crop&&i?[e.crop[2],e.crop[3]]:e.crop&&s?[e.crop[4]*(e.crop[6]+1),e.crop[5]*(e.crop[7]+1)]:e.f&&!r?[this._eng.imgs[e.f].width,this._eng.imgs[e.f].height]:[0,0];return[[t[0]*-(e.ox??.5)*(e.sx??e.s??1),t[1]*-(e.oy??.5)*(e.sy??e.s??1)],[],[t[0]*(e.sx??e.s??1),t[1]*(e.sy??e.s??1)],[]]}dom;scene=null;_ctx;_eng;constructor(e="",r,i=640,s=360){this.dom=typeof e!="string"?e:e.length&&document.querySelector(e)?document.querySelector(e):document.createElement("canvas"),this.dom.style.aspectRatio=`${i} / ${s}`,this.w=i,this.h=s,this._ctx=this.dom.getContext("2d"),this._ctx.imageSmoothingEnabled=!1,this._eng=r,r.cameras.push(this),r.inp.bind(this)}},re=class{x=0;_x=0;_gx=0;get dx(){return this.x-this._x}set dx(e){this._x=this.x-e}y=0;_y=0;_gy=0;get dy(){return this.y-this._y}set dy(e){this._y=this.y-e}rx=0;_rx=0;_grx=0;get drx(){return this.rx-this._rx}set drx(e){this._rx=this.rx-e}ry=0;_ry=0;_gry=0;get dry(){return this.ry-this._ry}set dry(e){this._ry=this.ry-e}b=0;_b=0;get db(){return this.b^this._b}set db(e){this._b=this.b^e}cb(e,r=null){return(this.db&e)!=0&&(r==null?(this.b&e)!=0:(this.b&e)==r)}sx=0;_sx=0;get dsx(){return this.sx-this._sx}set dsx(e){this._sx=this.sx-e}sy=0;_sy=0;get dsy(){return this.sy-this._sy}set dsy(e){this._sy=this.sy-e}get gx(){return this.x-this._gx}get gy(){return this.y-this._gy}get grx(){return this.rx-this._grx}get gry(){return this.ry-this._gry}get g(){return Math.hypot(this.gx,this.gy)}get gr(){return Math.hypot(this.grx,this.gry)}click(e=1){return this.g<e&&this.cb(1,0)}over(e,r=[0,0],i){let s=i??(this._cam.def.c!=null?this._cam.def.c:1),t=(this.x-this._cam.w/2*s+this._cam.x*s*this._cam.sx)*Math.pow(this._cam.sx,-s)-r[0],p=(this.y-this._cam.h/2*s+this._cam.y*s*this._cam.sy)*Math.pow(this._cam.sy,-s)-r[1],n=!1;for(let a=0,m=e.length-1;a<e.length;m=a++){let h=e[a].length==2&&e[m].length==2;if(a==0&&e[m].length==0&&m--,a!=0&&a+1<e.length&&e[a].length==0&&e[a-1].length==2&&e[a+1].length==2){let l=e[a-1][0],c=e[a-1][1],x=l+e[a+1][0],k=c+e[a+1][1];c>p!=k>p&&l>t!=x>t&&(n=!n),a++}else if(h){let l=e[a][0],c=e[a][1],x=e[m][0],k=e[m][1];c>p!=k>p&&t<(x-l)*(p-c)/(k-c)+l&&(n=!n)}}return n}in(...e){for(let r of e)if(this.x>r[0]&&this.x<r[0]+r[2]&&this.y>r[1]&&this.y<r[1]+r[3])return!0;return!1}rin(...e){for(let r of e)if(this.rx>r[0]&&this.rx<r[0]+r[2]&&this.ry>r[1]&&this.ry<r[1]+r[3])return!0;return!1}key={};dkey={};handle(e){if(e instanceof WheelEvent)this.sx+=e.deltaX,this.sy+=e.deltaY;else if(e instanceof MouseEvent){let r=this._cam.dom.getBoundingClientRect(),i=this._cam.w/this._cam.h,s=i>r.width/r.height?[r.width,r.width/i]:[r.height*i,r.height];this.x=(e.clientX-r.left-(r.width-s[0])/2)/s[0]*this._cam.w,this.y=(e.clientY-r.top-(r.height-s[1])/2)/s[1]*this._cam.h,this.rx=(this.x-this._cam.w/2+this._cam.x)/this._cam.sx,this.ry=(this.y-this._cam.h/2+this._cam.y)/this._cam.sy,this.b=e.buttons,this.cb(1)&&(this._gx=this.x,this._gy=this.y,this._grx=this.rx,this._gry=this.ry),e.preventDefault()}else e instanceof KeyboardEvent&&(e.type=="keydown"?this.key[e.key.toLowerCase()]=this.dkey[e.key.toLowerCase()]=Number(e.ctrlKey)+(Number(e.shiftKey)<<1)+(Number(e.altKey)<<2):(delete this.key[e.key.toLowerCase()],this.dkey[e.key.toLowerCase()]=-1))}reset(){this.dx=0,this.dy=0,this.db=0,this.dsx=0,this.dsy=0,this.drx=0,this.dry=0,this.dkey={}}constructor(e){this._eng=e}_eng;bind(e){this._cam=e,addEventListener("wheel",r=>this.handle(r)),addEventListener("mousemove",r=>this.handle(r)),addEventListener("mouseover",r=>this.handle(r)),addEventListener("mousedown",r=>this.handle(r)),addEventListener("mouseup",r=>this.handle(r)),addEventListener("mouseenter",r=>this.handle(r)),addEventListener("mouseout",r=>this.handle(r)),addEventListener("keydown",r=>this.handle(r)),addEventListener("keyup",r=>this.handle(r))}_cam},w=class{static res=[];static depend=[];render(e,r,i){return[]}eng=null;scene=null;constructor(...e){}},L=class{entities=[];add(...e){for(let r of e)r.eng=this.eng,this.entities.push(r)}remove(...e){for(let r=0;r<this.entities.length;r++)e.includes(this.entities[r])&&(this.entities.slice(r,1),r--)}show(e){e?e.scene=this:this.eng.cameras.length&&(this.eng.cameras[0].scene=this)}eng;constructor(e,...r){this.eng=e,this.add(...r)}},j=class{imgs={};fonts={};audios={};base="";load(e,...r){let i=[];for(let s of r)i.push(...s.res),s.depend.length&&i.push(...this.load(null,...s.depend));return e!=null&&this.load_res(e,...i),i}load_res(e,...r){let i=[],s=!1,t=(n,a)=>{n==-1&&(this.load_err.push(this.base+r[a]),s=!0),i[a][0]=n,e(s?-1:i.map(m=>m[0]/m[1]).reduce((m,h)=>m+h)/i.length)},p=0;for(let n of r){if(n in this.imgs||n in this.fonts||n in this.audios){i.push([0,1]),t(1,p),p++;continue}let a=n.split(".").reverse()[0].toLowerCase();if(["png","jpg","jpeg"].includes(a)){i.push([0,1]);let m=new Image,h=p;m.onload=()=>t(1,h),m.onerror=()=>t(-1,h),m.src=this.base+n,this.imgs[n]=m}else if(["mp3","wav"].includes(a)){i.push([0,1]),this.audios[n]=new Audio;let m=p,h=this.audios[n];h.active=!1,h.oncanplaythrough=()=>t(1,m),h.onerror=()=>t(-1,m),h.src=this.base+n,h.volume=0,h.addEventListener("ended",()=>{h.currentTime=0,h.play()}),h.load()}else if(["ttf","mp3","wav"].includes(a)){i.push([0,5]);let m=p,h=new XMLHttpRequest;h.open("GET",this.base+n),h.responseType="blob",h.onreadystatechange=()=>{if(t(h.readyState,m),h.readyState==4&&h.status!=200)return t(-1,m);if(!(h.readyState!=4||h.status!=200)){if(a=="ttf"){let l=this.fonts[n]=`font_${Object.keys(this.fonts).length}`,c=document.createElement("h1");c.style.font=`20px ${l}`,c.innerHTML=l,c.style.position="fixed",c.style.left="0",c.style.top="100%";let x=document.createElement("style");x.innerHTML+=`@font-face {font-family:"${l}";src:url("${URL.createObjectURL(h.response)}") format("truetype");}`,document.head.appendChild(x),document.body.appendChild(c);let k=I=>{document.fonts.check(`20px ${l}`)?t(5,m):I>1e3?t(-1,m):setTimeout(k,10,I+1)};k(0)}if(["mp3","wav"].includes(a)){this.audios[n]=new Audio;let l=this.audios[n];l.active=!1,l.src=URL.createObjectURL(h.response),l.volume=0,l.addEventListener("ended",()=>{l.currentTime=0,l.play()}),t(5,m)}else t(5,m)}},h.send()}else i.push([0,1]),this.error_add(new Error(`Unknown file type "${a}"`)),t(-1,p);p++}s||e(0)}errors=[];load_err=[];error_add(e){for(let r of this.errors)if(r.message==e.message)return;this.errors.push(e),console.log(e)}cameras=[];inp;debug={m:[1,0,0,1,0,0],_m:[1,0,0,1,0,0],mp:e=>{if(this.inp.key.a!=null&&(this.debug.m[0]-=e*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.m[0]+=e*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),this.inp.key.q!=null&&(this.debug.m[1]-=e*(this.inp.key.q==0?1:this.inp.key.q&2?.25:0)),this.inp.key.e!=null&&(this.debug.m[1]+=e*(this.inp.key.e==0?1:this.inp.key.e&2?.25:0)),this.inp.key.x!=null&&(this.debug.m[2]-=e*(this.inp.key.x==0?1:this.inp.key.x&2?.25:0)),this.inp.key.z!=null&&(this.debug.m[2]+=e*(this.inp.key.z==0?1:this.inp.key.z&2?.25:0)),this.inp.key.s!=null&&(this.debug.m[3]-=e*(this.inp.key.s==0?1:this.inp.key.s&2?.25:0)),this.inp.key.w!=null&&(this.debug.m[3]+=e*(this.inp.key.w==0?1:this.inp.key.w&2?.25:0)),this.inp.key.c!=null&&(this.debug.m[4]-=e*(this.inp.key.c==0?4:this.inp.key.c&2?.25:0)),this.inp.key.v!=null&&(this.debug.m[4]+=e*(this.inp.key.v==0?4:this.inp.key.v&2?.25:0)),this.inp.key.r!=null&&(this.debug.m[5]-=e*(this.inp.key.r==0?4:this.inp.key.r&2?.25:0)),this.inp.key.f!=null&&(this.debug.m[5]+=e*(this.inp.key.f==0?4:this.inp.key.f&2?.25:0)),this.inp.key[1]!=null||this.inp.key[2]!=null){let r=Math.PI/16*e*(this.inp.key[1]!=null?1:-1),i=Math.cos(r),s=Math.sin(r),t=[...this.debug.m];this.debug.m=[t[0]*i+t[2]*s,t[1]*i+t[3]*s,t[2]*i-t[0]*s,t[3]*i-t[1]*s,t[4],t[5]]}if(!Object.keys(this.inp.key).length){for(let r=0;r<6;r++)if(this.debug.m[r]!=this.debug._m[r]){console.log("DEBUG MATRIX:",this.debug.m.toString()),this.debug._m=[...this.debug.m];break}}},v:1,vp:e=>{this.inp.key.a!=null&&(this.debug.v-=e*(this.inp.key.a==0?1:this.inp.key.a&2?.25:0)),this.inp.key.d!=null&&(this.debug.v+=e*(this.inp.key.d==0?1:this.inp.key.d&2?.25:0)),console.log(this.debug.v)}};_wait=0;_times=[];_start;get fps(){return this._times.length}set fps(e){this._wait=e?2e3/e:0}scene=null;start_loop(e=!0){let r=performance.now(),i=this._times.length?r-this._times[this._times.length-1]:0;this._times=this._times.filter(t=>r-t<=1e3),this._times.push(r),e&&(this._start=r);for(let t in this.audios)this.audios[t].active=!1;let s=0;for(let t of this.cameras){t.cursor="default",t.clear(),t.fit&&t.fitfull(),t.tolisten=[];let p=[];if(t.scene!=null)for(let m of t.scene.entities){let h=v(m.render(i/1e3,r-this._start,t));for(let l of h)p.push(l)}let n=0,a=0;for(let m=p.length-1;m>=0;m--){let h=p[m];!h.hover&&!h.press&&!h.click||(h.p==null&&(h.p=t.rect(h)),this.inp.over(h.p,[h.x??0,h.y??0],h.c??1)&&(a==0&&h.hover&&h.hover(h),n==0&&h.click&&this.inp.click()&&(h.click(h),n++),h.press&&this.inp.b&1&&this.inp.g<1&&h.press(h)))}t.render({},...p),t.dom.style.cursor=t.cursor,this.loop(i/1e3,r-this._start,t),s++}for(let t in this.audios){let p=this.audios[t];p.active&&p.paused?p.play():!p.active&&!p.paused&&(p.currentTime=0,p.pause())}this.inp.reset(),setTimeout(()=>this.start_loop(!1),this._wait-i>0?this._wait-i:0)}loop=()=>{};constructor(){this.inp=new re(this),this.start_loop()}};function v(o){if(!o.length)return o;let[e,...r]=o,i=[];for(let s of r)i.push({...e,...s});return i}function me(o,e,r=0,i=0,s=1,t=1){let p=(n,a,m)=>{let h=`${r+a}_${i+m}`,l=0;e[h]&&e[h].data&&e[h].data.p&&(l=e[h].data.p);let c=structuredClone(o[l|n]);c.f||(c.f="tile/test.png"),c.data={...e[h]?.data||{},...o[l|n]?.data||{},p:l|n},e[h]=c};for(let n=0;n<s;n++)for(let a=0;a<t;a++)p(15,n,a);for(let n=0;n<s;n++)p(3,n,-1);for(let n=0;n<s;n++)p(12,n,t);for(let n=0;n<t;n++)p(5,-1,n);for(let n=0;n<t;n++)p(10,s,n);p(1,-1,-1),p(2,s,-1),p(4,-1,t),p(8,s,t)}var S=class extends w{per=0;start=()=>{};render(e,r,i){return this.eng==null?[]:[{c:0},...this.per!=1?[{p:[[-100,-10],[],[200,20],[]],b:this.per<0?"red":"white",bz:2,x:i.w/2,y:i.h/2},{a:this.per<0?0:1,p:[[-96,-6],[],[192*this.per,12],[]],f:"white",x:i.w/2,y:i.h/2},{t:this.per<0?"Error loading assets":"Loading...",f:this.per<0?"red":"white",x:i.w/2,y:i.h/2-30},{a:this.per<0?.75:0,t:`failed: ${this.eng.load_err[this.eng.load_err.length-1]}`,tz:15,f:"red",x:i.w/2,y:i.h/2+30}]:[{x:i.w/2,y:i.h/2,t:"Click to start game",f:"white"},{p:[[0,0],[],[i.w,i.h],[]],click:s=>this.start()}]]}};var g=class extends w{static key="";item="";focused=!1;own=1;price=0;on_focused=()=>{};popup=[];x;y;name="Building";base(e,r,i,s=1){this._c+=((this.focused?0:1)-this._c)*e*10;let t=this._c;return{c:t,x:this.x*t+.25*i.w*(1-t),y:this.y*t+.6*i.h*(1-t),s:s*t+1*(1-t),click:p=>{this.focused=!0,this.on_focused(this)}}}_c=1;render_pin(e,r,i,s=1){return this.popup.length==0?[]:[{x:this.x,y:this.y-100},{f:"ui/pin.png",s:.25,oy:.4,click:t=>{this.focused=!0,this.on_focused(this)}},...this.popup]}menu(e,r,i,s){return[]}constructor(e,r,i,s){super(),this.eng=e.eng,this.x=r*72+i*64,this.y=i*36-r*19}};var se=class{money=0;own=[];item=[];saving=0;loan=0;logs=[[],[]];last=0;day=0;update(){performance.now()-this.last<1e3||(this.logs[0].push(this.saving),this.logs[1].push(this.loan),this.last=performance.now(),this.logs[0]=this.logs[0].slice(-100),this.logs[1]=this.logs[1].slice(-100))}loaned(e){if(e<0&&this.money<-e)return z([{t:"Insufficent funds ",f:"#F44336",tz:15}]);if(this.loan>1e5)return z([{t:"Reached Max loaned",f:"#F44336",tz:15}]);this.loan+e>1e5&&(z([{t:"Reached Max loaned",f:"black",tz:15}]),e=1e5-this.loan),this.money+=e,this.loan+=e}saved(e){if(e<0&&this.saving<-e)return z([{t:"Insufficent savings ",f:"#F44336",tz:15}]);if(this.money<e)return z([{t:"Insufficent funds",f:"#F44336",tz:15}]);this.money-=e,this.saving+=e}purchase(e){if(this.money<e.price)return z([{t:"Insufficent funds",f:"#F44336",tz:15}]);this.money-=e.price,e.own=2,this.own.push(e)}},d=new se;var u=class extends w{name="";quantity=0;price=0;base(e,r,i,s=1){return{c:0}}menu(e,r,i){return[]}constructor(){super()}};var F=class extends u{static res=["item/beef.png"];name="Beef";price=400;render(e,r,i){return[this.base(e,r,i),{f:"item/beef.png",s:.125,m:[1,0,0,1,0,-90]}]}};var R=class extends u{static res=["item/carrot.png"];name="Carrot";price=130;render(e,r,i){return[this.base(e,r,i),{f:"item/carrot.png",s:.125,m:[1,0,0,1,0,-70]}]}};var A=class extends u{static res=["item/chicken.png"];name="Chicken";price=185;render(e,r,i){return[this.base(e,r,i),{f:"item/chicken.png",s:.125,m:[1,0,0,1,0,-90]}]}};var q=class extends u{static res=["item/fertilizer.png"];name="Fertilizer";price=32;render(e,r,i){return[this.base(e,r,i),{f:"item/fertilizer.png",s:.125,m:[1,0,0,1,0,-70]}]}};var H=class extends u{static res=["item/fish.png"];name="Fish";price=175;render(e,r,i){return[this.base(e,r,i),{f:"item/fish.png",s:.125,m:[1,0,0,1,0,-70]}]}};var O=class extends u{static res=["item/garlic.png"];name="Garlic";price=250;render(e,r,i){return[this.base(e,r,i),{f:"item/garlic.png",s:.125,m:[1,0,0,1,0,-90]}]}};var P=class extends u{static res=["item/kadyos.png"];name="Kadyos";price=200;render(e,r,i){return[this.base(e,r,i),{f:"item/kadyos.png",s:.125,m:[1,0,0,1,0,-90]}]}};var U=class extends u{static res=["item/langka.png"];name="Langka";price=100;render(e,r,i){return[this.base(e,r,i),{f:"item/langka.png",s:.125,m:[1,0,0,1,0,-90]}]}};var X=class extends u{static res=["item/pork.png"];name="Pork";price=350;render(e,r,i){return[this.base(e,r,i),{f:"item/pork.png",s:.125,m:[1,0,0,1,0,-90]}]}};var D=class extends u{static res=["item/radish.png"];name="Radish";price=50;render(e,r,i){return[this.base(e,r,i),{f:"item/radish.png",s:.125,m:[1,0,0,1,0,-90]}]}};var K=class extends u{static res=["item/soup.png"];name="Soup";price=35;render(e,r,i){return[this.base(e,r,i),{f:"item/soup.png",s:.15,m:[1,0,0,1,0,-60]}]}};var Y=class extends u{static res=["item/tomato.png"];name="Tomato";price=80;render(e,r,i){return[this.base(e,r,i),{f:"item/tomato.png",s:.125,m:[1,0,0,1,0,-90]}]}};var N=class extends u{static res=["item/tuna.png"];name="Tuna";price=270;render(e,r,i){return[this.base(e,r,i),{f:"item/tuna.png",s:.15,m:[1,0,0,1,0,-60]}]}};var W=class extends u{static res=["item/worm.png"];name="Worm";price=650;render(e,r,i){return[this.base(e,r,i),{f:"item/worm.png",s:.125,m:[1,0,0,1,0,-90]}]}};var E=[H,F,R,A,q,O,P,U,X,D,K,Y,N,W];function y(o,e,r=1,i=1,s=0){let t=[];"t"in o&&(t.push({t:o.t,tz:o.tz??20,b:"black",bz:o.bz??4,x:o.x??0,y:(o.y??0)+3,f:o.f??"white"}),delete o.t,delete o.tz,delete o.f,delete o.bz),"f"in o&&(t.push({f:o.f,x:(o.x??0)+(o.data?.x??0),y:(o.y??0)+(o.data?.y??0),s:.25,o:o.o??"",r:o.r??0,a:s==3?.5:1}),delete o.f,delete o.r);let p=o.click;return"click"in o&&delete o.click,o.click=n=>{n.data&&n.data.disabled||(n.data?.button&&e.play("sfx/button.mp3",.25),p&&p(n))},[{f:s==3?"ui/button_disabled.png":s==2?"ui/button_down.png":"ui/button_up.png",s:.25,crop:[60,59,60,59,57,56,r,i],press:n=>{n.data&&n.data.button&&(n.f="ui/button_down.png")},...o,data:{...o.data??{},button:s==0,disabled:s==3}},...t]}var $=class o extends w{static res=["coins.png","ui/title.png","ui/resume.png","ui/options.png","ui/exit.png","ui/close.png","ui/menu.png","ui/bag.png","ui/next.png","font/emulogic.ttf","music/bgm1_prototype.wav","sfx/button.mp3","sfx/whoosh.mp3","ui/button_up.png","ui/button_down.png","ui/button_disabled.png","plan.png"];static depend=E;pop=[];pop_c=0;pop_t=0;help=0;help_c=0;closed=()=>{};popup(e){this.pop=e,this.pop_t=0}focused=()=>{};menu=0;m=0;focus=null;title="Inventory";render(e,r,i){if(this.eng==null)return[];if(this.pop_c+=((this.pop.length?1:0)-this.pop_c)*e*10,this.pop.length&&this.pop_t==0){this.pop_t=performance.now();for(let n of this.pop)n.c=n.c??0}this.pop.length&&performance.now()-this.pop_t>3e3&&(this.pop=[]),this.help_c+=(this.help-this.help_c)*e*10,this.eng.inp.dkey.q==0&&(this.help=1-this.help),this.m+=(this.menu-this.m)*e*10,this.menu!=2&&this.focus!=null&&Math.abs(this.m-2)>.99&&(this.focus=null);let s=(...n)=>n.map(a=>Math.max(0,1-Math.abs(this.m-a))).reduce((a,m)=>a+m,0),t=Math.floor(r/200)%4,p=(n,a=1,m=1,h=0)=>y(n,i,a,m,h);return[{c:0,hover:n=>{n.click&&(n.cur="pointer")},tf:"font/emulogic.ttf"},{f:"music/bgm1_prototype.wav"},{f:"black",p:[[0,0],[],[i.w,i.h]],a:.5*s(0,2),click:this.menu==1?void 0:()=>{}},...this.focus==null?[]:v(this.focus.render(e,r,i)),{x:i.w*.5,y:i.h*.25*(2*s(0)-1),f:o.res[1],s:.35},{f:"coins.png",x:(i.w*.72+25)*s(0)-50*s(0)+25,y:(i.h*.2+25)*s(0)-50*s(0)+25,crop:[Math.abs(2-t)*22,0,22,23],sx:t==1?-1.5:1.5,sy:1.5},{t:String(d.money),tz:20,x:44,y:28-38*s(0),o:"w",f:"gold",b:"black",bz:4},{t:String(d.day),tz:20,x:i.w-130,y:28-38*s(0,2),o:"e",f:"white"},{t:String(this.eng.fps),o:"nw",tz:8},...p({x:i.w/2,y:i.h-200*s(0)+50,t:"resume",f:"#4CAF50",click:n=>this.menu=1},10,2),...p({x:i.w/2,y:i.h-200*s(0)+105,t:"options",f:"#2196F3"},10,2),...p({x:i.w/2,y:i.h-200*s(0)+160,t:"exit",f:"#F44336"},10,2),...p({x:i.w+30-40*s(1),y:10,o:"ne",f:"ui/menu.png",click:n=>this.menu=0,data:{x:-3,y:9}}),...p({x:i.w+30-80*s(1),y:10,o:"ne",f:"ui/bag.png",click:n=>{this.title="Inventory",this.menu=2},data:{x:-7,y:7}}),...p({x:i.w+30-120*s(1),y:10,o:"ne",f:"ui/next.png",click:n=>{},data:{x:-10,y:9}}),...p({x:i.w+70-80*s(2),y:10,o:"ne",f:"ui/close.png",click:n=>{this.closed(),this.focus&&(this.focus.focused=!1),this.menu=1},data:{x:-4,y:6}}),...this.focus==null||this.title.toLowerCase()=="inventory"?[...p({x:i.w/2,y:i.h+150-(i.h/2+135)*s(2)},40,20,1),...Array(32).fill(0).map((n,a)=>{let m=a%8,h=Math.floor(a/8);return{c:0,f:"ui/button_down.png",s:.25,crop:[60,59,60,59,57,56,3,3],x:75+70*m,y:90+70*h+(i.h-50)*(1-s(2))}}),...d.own.map((n,a)=>{let m=a%8,h=Math.floor(a/8);return[...v(n.render(e,r,i)).map(l=>(l.c=0,l.x=75+70*m,l.y=100+70*h+(i.h-50)*(1-s(2)),l.s=.25,l.click=void 0,l)),{c:0,x:75+70*m,y:90+70*h+(i.h-50)*(1-s(2)),p:[[-28,-28],[],[58,57],[]],click:l=>{i.x=n.x,i.y=n.y,this.menu=1}}]}).flat(),...d.item.map((n,a)=>{let m=(a+d.own.length)%8,h=Math.floor((a+d.own.length)/8);return v(n.render(e,r,i)).map(l=>(l.x=75+70*m,l.y=100+70*h+(i.h-50)*(1-s(2)),l))}).flat()]:[...p({x:i.w+150-(i.w/2+5)*s(2),y:i.h/2+15},20,19,1),...p({x:i.w/4,y:i.h+25-(i.h/8+25)*s(2),...[{t:"Cant Own",f:"#F44336"},{t:"Purchase",f:"#4CAF50",click:n=>{this.focus instanceof g&&d.purchase(this.focus)}},{t:"Sell",f:"#2196F3"}][this.focus.own]??{t:"Unknown",f:"#F44336"}},15,2),...this.focus.price&&this.focus.own==1?[{t:`\u20B1${this.focus.price}`,x:i.w/4,y:i.h+25-(i.h/4+15)*s(2),f:"white",a:.75}]:[],...this.focus.menu(e,r,i,s(2)).map(n=>(n.c=n.c??0,n.x=(n.x??0)+i.w+150-(i.w/2+5)*s(2),n.y=(n.y??0)+i.h/2+15,n))],...this.title.toLowerCase()=="inventory"?[{t:this.title,tz:20,b:"black",bz:4,x:i.w/2,y:28*s(2)-10*(1-s(2)),f:"skyblue"}]:[{t:this.title,tz:15,b:"black",bz:4,x:i.w/4,y:70*s(2)-10*(1-s(2)),f:"skyblue"}],...p({x:i.w/2,y:50*this.pop_c-30,click:n=>this.pop=[]},22,3),...this.pop.map(n=>(n.x=i.w/2,n.y=50*this.pop_c-25,n)),{f:"plan.png",o:"nw",s:.5,y:i.h*(1-this.help_c)}]}};var G=class extends g{static res=["building/bank.png"];static key="bank";item="building/bank.png";own=0;name="DBO Bank";act_loan_pay=!1;act_save_out=!1;render(e,r,i){return[this.base(e,r,i),{f:"building/bank.png",p:[[-62,-100],[],[133,130],[]],m:[1,0,0,1,4,-32]}]}menu(e,r,i){let s=d.logs[0],t=d.logs[1],p=Math.max(100,Math.max(...s,...t));return[...y({x:0,y:-98},i,19,4,2),{p:s.length<2?[[0,55],[270,55]]:s.map((n,a)=>[270*a/(s.length-1),55*(1-n/p)]),b:"green",x:-135,y:-125,bz:2,a:.5},{p:t.length<2?[[0,55],[270,55]]:t.map((n,a)=>[270*a/(t.length-1),55*(1-n/p)]),b:"red",x:-135,y:-125,bz:2,a:.5},{t:"Savings (5% rate)",o:"w",x:-140,y:-30,f:"black",tz:10,a:.75},{t:String(d.saving),o:"w",x:-140,y:-10,f:"black",tz:15},...y({x:-100,y:15,t:"1,000",tz:15,f:"black",bz:0,click:n=>d.saved(1e3*(this.act_save_out?-1:1))},i,5,1),...y({x:0,y:15,t:"10,000",tz:15,f:"black",bz:0,click:n=>d.saved(1e4*(this.act_save_out?-1:1))},i,6,1),...y({x:100,y:15,t:"100k",tz:15,f:"black",bz:0,click:n=>d.saved(1e5*(this.act_save_out?-1:1))},i,5,1),...y({x:90,y:-20,t:this.act_save_out?"deposit":"withdraw",tz:10,f:"black",bz:0,click:n=>this.act_save_out=!this.act_save_out},i,6,1),{t:"Loans (8% rate)",o:"w",x:-140,y:70,f:"black",tz:10,a:.75},{t:String(d.loan),o:"w",x:-140,y:90,f:"black",tz:15},...y({x:-100,y:115,t:"1,000",tz:15,f:"black",bz:0,click:n=>d.loaned(1e3*(this.act_loan_pay?-1:1))},i,5,1),...y({x:0,y:115,t:"10,000",tz:15,f:"black",bz:0,click:n=>d.loaned(1e4*(this.act_loan_pay?-1:1))},i,6,1),...y({x:100,y:115,t:"100k",tz:15,f:"black",bz:0,click:n=>d.loaned(1e5*(this.act_loan_pay?-1:1))},i,5,1),...y({x:90,y:80,t:this.act_loan_pay?"take loan":"pay back",tz:10,f:"black",bz:0,click:n=>this.act_loan_pay=!this.act_loan_pay},i,6,1)]}};var J=class extends g{static res=["building/blank_mask.png"];static key="blank";item="building/blank_mask.png";own=0;name="Private building";color=["white","white","white"];render(e,r,i){let s=this.base(e,r,i);return[{x:s.x??0,y:s.y??0,c:s.c??1},{p:[[-45,-33],[0,-7],[50,-20],[50,11],[0,24],[-38,2],[-45,0],[]],f:this.color[0]},{p:[[-45,-65],[0,-39],[50,-52],[50,-20],[0,-7],[-45,-33],[]],f:this.color[1]},{p:[[-49,-69.5],[8,-85],[54,-58],[54,-54],[53,-53],[53,-50],[0,-36],[-47,-64],[-47,-65],[-49,-67],[]],f:this.color[2]},{f:"building/blank_mask.png",p:[[-48,-85],[],[102,110],[]],m:[1,0,0,1,0,-30],...s}]}constructor(e,r,i,s){super(e,r,i,s),s.color?.length==3&&(this.color=s.color)}};var Q=class extends g{static res=["building/callereal.png","ui/triangle.png"];static key="callereal";static depend=E;item="building/callereal.png";own=0;name="Calle Real";items=[];page=0;constructor(e,r,i,s){super(e,r,i,s);for(let t of E)this.items.push(new t)}render(e,r,i){return[this.base(e,r,i),{f:"building/callereal.png",p:[[-85,-140],[],[185,160],[]],m:[1,0,0,1,0,-60]}]}menu(e,r,i,s){return[...y({x:0,y:-98},i,19,4,2),...this.items.slice(4*this.page,4*(this.page+1)).map((t,p)=>[...y({x:0,y:-36+48*p},i,19,2),...v(t.render(e,r,i)).map(n=>(n.x=-120,n.y=-26+48*p,n)),{t:t.name,x:-100,y:-46+48*p,o:"nw",tz:15}]).flat(),...y({x:-170+40*(1-s),y:50,f:"ui/triangle.png",r:-Math.PI/2,click:t=>{this.page--}},i,1,1,this.page>0?0:3),...y({x:-170+40*(1-s),y:80,f:"ui/triangle.png",r:Math.PI/2,click:t=>{this.page++}},i,1,1,this.page*4+4<this.items.length?0:3)]}};var V=class extends g{static res=["building/factory.png"];static key="factory";item="building/factory.png";name="Factory";render(e,r,i){return[this.base(e,r,i),{f:"building/factory.png",p:[[-75,-125],[],[165,145],[]],m:[1,0,0,1,0,-50]}]}};var Z=class extends g{static res=["building/farm.png"];static key="farm";item="building/farm.png";name="Farm";price=5e4;render(e,r,i){return[this.base(e,r,i),{f:"building/farm.png",p:[[-64,-49],[],[120,97],[]],m:[1,0,0,1,0,-10]}]}};var ee=class extends g{static res=["building/fishing.png"];static key="fishing";item="building/fishing.png";name="Fishing Area";price=5e4;render(e,r,i){return[this.base(e,r,i,.75),{f:"building/fishing.png",m:[1,0,0,1,5,-35],p:[[-70,-80],[],[145,110],[]]}]}};var le=[G,J,Q,V,Z,ee];var T=class o extends w{static res=["tile/grass_0.png","tile/sand_0.png","tile/sand1.png","tile/water_0.png","tile/water_1.png","tile/ws_x_0.png","tile/ws_y_0.png","tile/ws_xy_0.png","tile/ws__0.png","tile/ws_x_1.png","tile/ws_y_1.png","tile/ws_xy_1.png","tile/ws__1.png","tile/test.png","road/dirt.png","road/dirt_empty.png","road/cement.png","road/cement_empty.png","prop/tree.png","prop/bush.png","tile/water_bg_0.png","tile/water_bg_1.png","ui/pin.png"];static depend=le;ly=[{},{}];focused=()=>{};generate(e=[]){this.ly=[{},{}];let[r,i]=this.ly;for(let s of e){let t=!0,p=`${s.x}_${s.y}`;if(s.w==null&&(s.w=1),s.h==null&&(s.h=1),s.type=="sand")me([{},{data:{pre:"ws_xy"},m:[.312,.463,-2.45,-.23,-1,1]},{data:{pre:"ws_xy"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_y"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_xy"}},{data:{pre:"ws_x"}},{},{data:{pre:"ws_"},m:[-.2404,-.45704,2.5288,.2536,0,0]},{data:{pre:"ws_xy"},m:[-.355,.37,2.31,.38,-1,1]},{},{data:{pre:"ws_x"},m:[-1,0,0,-1,-1,1]},{data:{pre:"ws_"},m:[1,0,0,1,-2,0]},{data:{pre:"ws_y"}},{data:{pre:"ws_"},m:[.95175,.235,.275,-.951,0,.6285]},{data:{pre:"ws_"},m:[.26139,.4746,-2.4687,-.27096,4.952,2.076]},{data:{pre:"sand"}}],r,s.x,s.y,s.w,s.h);else if(s.type=="grass"){let n="";for(let a=0;a<s.w;a++)for(let m=0;m<s.h;m++)r[n=`${a+s.x}_${m+s.y}`]&&r[n].data?.pre=="sand"&&(r[n].data={...r[n].data||{},top:"grass"})}else if(s.type=="dirt")for(let n=0;n<s.w;n++){let a=`${s.v?s.x:s.x+n}_${s.v?s.y+n:s.y}`;a in i?i[a]={f:"road/dirt_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:a in r&&(i[a]={f:"road/dirt.png",m:s.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else if(s.type=="cement")for(let n=0;n<s.w;n++){let a=`${s.v?s.x:s.x+n}_${s.v?s.y+n:s.y}`;a in i?i[a]={f:"road/cement_empty.png",m:[1.33725,-.071745,-.24675,1.2205,0,0]}:a in r&&(i[a]={f:"road/cement.png",m:s.v?[1.33725,-.071745,-.24675,1.2205,0,0]:[-1.27025,-.39275,0,1.2135,0,0]})}else s.type=="tree"?i[p]={f:"prop/tree.png",m:[1,0,0,1,0,-25]}:s.type=="bush"?i[p]={f:"prop/bush.png",s:.08}:s.type=="test"?i[p]={f:"tile/test.png",a:.5}:t=!1;if(!t){for(let n of o.depend)if(s.type==n.key){let a=new n(this,s.x,s.y,s);a.on_focused=m=>this.focused(m),i[p]={data:{build:a}},t=!0,d.own.push(a)}}t||this.eng?.error_add(new Error(`Unknown type "${s.type}`))}for(let s in this.ly)for(let t in this.ly[s]){let p=t.split("_").map(a=>Number(a)),n=this.ly[s][t];Object.assign(n,{x:p[0]*72+p[1]*64,y:p[1]*36-p[0]*19}),s=="0"&&n.data?.pre&&(n.f=`tile/${n.data.top||n.data.pre}_0.png`)}}init=!0;render(e,r,i){i.tile({f:`tile/water_bg_${Math.floor(r/800)%2}.png`,s:.5});for(let s in this.ly[0]){let t=this.ly[0][s];t.data&&t.data.pre&&t.data.pre[0]=="w"&&!t.data.top&&(t.f=`tile/${t.data.pre}_${Math.floor(r/800)%2}.png`)}return[{hover:s=>{s.click&&(s.cur="pointer")}},...Object.values(this.ly[0]),...Object.values(this.ly[1]).map(s=>{if(s.data?.build){let t=s.data.build;return[...v(t.render(e,r,i)),...v(t.render_pin(e,r,i))]}return[s]}).reduce((s,t)=>[...s,...t],[])]}};var ne=[{type:"sand",x:-10,y:-10,w:20,h:20},{type:"grass",x:-9,y:-9,w:18,h:18},{type:"fishing",x:7,y:9},{type:"dirt",x:3,y:-8,w:16,v:!0},{type:"cement",x:-8,y:1,w:16},{type:"bank",x:2,y:0},{type:"tree",x:1.3,y:.3},{type:"callereal",x:0,y:0},{type:"factory",x:-5,y:0},{type:"blank",x:5,y:0,color:["blue","brown","violet"]},{type:"blank",x:4,y:0,color:["red","yellow","green"]},{type:"bush",x:-2,y:0},{type:"test",x:-2,y:.001},{type:"farm",x:-2,y:0},{type:"tree",x:0,y:3},{type:"test",x:2,y:.001}];for(let o=0;o<10;o++)for(let e=0;e<10;e++)ne.push({type:"tree",x:-8+e*.5+(Math.random()-.5),y:-8+o*.5+(Math.random()-.5)});var C=new j,te=new B("#game",C);C.base="/assets/";te.fit=!0;te.scale(4);for(let o of E)d.item.push(new o);var oe=new S,fe=new L(C,oe);C.load(o=>{oe.per=o,o==1&&ue.show()},$,T);fe.show();oe.start=()=>{te.full(),ue.show()};var ae=new T(C),M=new $,ue=new L(C,ae,M);ae.generate(ne);ae.focused=o=>{te.play("sfx/whoosh.mp3",.25,.4),M.title=o.name,M.menu=2,M.focus=o};function z(o){return M.popup(o)}M.menu=1;C.loop=(o,e,r)=>{let i=C.inp;if(d.update(),M.menu==1){if(i.dsy){let s=Math.max(.08,Math.min(8,r.sx*Math.pow(1.5,-i.dsy/100)));r.s=s}if(i.cb(1)&&i.dx&&i.dy,i.b&1){r.x-=i.dx/r.sx,r.y-=i.dy/r.sy;let s=2e4*Math.min(1,r.sx),t=7800*Math.min(1,r.sy);r.x=Math.min(s,Math.max(-s,r.x)),r.y=Math.min(t,Math.max(-t,r.y))}}};})();</script></body></html>